<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Соціальна мережа - Era</title>
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/main.css">
  <link rel="icon" type="image/x-icon" href="./images/globe.svg">
  <style>
    :root {
      --primary-color: #0b93f6;
      --danger-color: #e74c3c;
      --success-color: #2ecc71;
      --dark-bg: #121212;
      --card-bg: #1a1a1a;
      --card-item-bg: #0f0f0f;
      --text-color: #ffffff;
      --text-secondary: #aaaaaa;
      --border-radius: 8px;
    }

    body {
      background-color: var(--dark-bg);
      color: var(--text-color);
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 15px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .btn {
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background-color: var(--primary-color);
    }

    .btn-success {
      background-color: var(--success-color);
    }

    .btn-danger {
      background-color: var(--danger-color);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* User Profile Section */
    .user-profile {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-right: 20px;
      object-fit: cover;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .user-username {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    /* User and Friend Cards */
    .user-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .user-card {
      background-color: var(--card-item-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s;
    }

    .user-card:hover {
      transform: translateY(-2px);
    }

    .user-card .user-avatar {
      width: 70px;
      height: 70px;
      margin-right: 0;
      margin-bottom: 10px;
    }

    .user-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Friend Request Items */
    .request-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .request-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: var(--card-item-bg);
      border-radius: var(--border-radius);
    }

    .request-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }

    .request-info {
      flex: 1;
    }

    .request-name {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .request-username {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .request-actions {
      display: flex;
      gap: 10px;
    }

    /* Chat Section */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 600px;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .chat-sidebar {
      width: 300px;
      background-color: var(--card-item-bg);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      overflow-y: auto;
    }

    .chat-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      display: flex;
      align-items: flex-start;
    }

    .message.incoming {
      align-self: flex-start;
      background-color: var(--card-item-bg);
    }

    .message.outgoing {
      align-self: flex-end;
      background-color: var(--primary-color);
    }

    .message-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .message.outgoing .message-avatar {
      order: 1;
      margin-right: 0;
      margin-left: 10px;
    }

    .message-content {
      display: flex;
      flex-direction: column;
    }

    .message-text {
      margin-bottom: 5px;
    }

    .message-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      align-self: flex-end;
    }

    .chat-form {
      padding: 15px;
      display: flex;
      gap: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 20px;
      border: none;
      background-color: var(--card-item-bg);
      color: var(--text-color);
    }

    /* Friend List in Chat */
    .friends-list {
      list-style: none;
    }

    .friend-item {
      padding: 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .friend-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .friend-item.active {
      background-color: rgba(11, 147, 246, 0.2);
    }

    .friend-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: 500;
      margin-bottom: 3px;
    }

    .friend-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .friend-unread {
      background-color: var(--primary-color);
      color: white;
      font-size: 12px;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    /* Tabs for different sections */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Search box */
    .search-container {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      border: none;
      background-color: var(--card-item-bg);
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Era Social</div>
      <div id="user-controls">
        <button id="logout-btn" class="btn btn-danger" style="display: none;">Вийти</button>
      </div>
    </div>

    <div id="auth-container" style="display: none;">
      <div class="section">
        <h2 class="section-title">Увійдіть для доступу до соціальної мережі</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Оберіть одного з тестових користувачів, щоб увійти в систему</p>
        <div id="test-users-list" class="user-list">
          <p style="color: var(--text-secondary);">Завантаження користувачів...</p>
        </div>
      </div>
    </div>

    <div id="main-content" style="display: none;">
      <!-- Профіль користувача -->
      <div class="section">
        <div id="user-profile" class="user-profile">
          <img id="current-user-avatar" src="./images/default-avatar.svg" class="user-avatar" alt="Avatar">
          <div class="user-details">
            <h2 id="current-user-name" class="user-name">Ім'я користувача</h2>
            <p id="current-user-username" class="user-username">@username</p>
          </div>
        </div>
      </div>

      <!-- Tabs навігація -->
      <div class="tabs">
        <div class="tab active" data-tab="social">Соціальне</div>
        <div class="tab" data-tab="messages">Повідомлення</div>
      </div>

      <!-- Tab content - Social -->
      <div id="social-tab" class="tab-content active">
        <div class="main-layout">
          <!-- Ліва колонка - Пошук і запити дружби -->
          <div class="sidebar">
            <!-- Пошук користувачів -->
            <div class="section">
              <h3 class="section-title">Пошук користувачів</h3>
              <div class="search-container">
                <input type="text" id="user-search" class="search-input" placeholder="Пошук за ім'ям або логіном...">
              </div>
              <div id="search-results" class="user-list">
                <!-- Тут будуть результати пошуку -->
              </div>
            </div>

            <!-- Запити на дружбу -->
            <div class="section">
              <h3 class="section-title">Запити на дружбу</h3>
              <div class="tabs">
                <div class="tab active" data-tab="received-requests">Отримані</div>
                <div class="tab" data-tab="sent-requests">Надіслані</div>
              </div>

              <!-- Отримані запити -->
              <div id="received-requests-tab" class="tab-content active">
                <div id="received-requests" class="request-list">
                  <p style="color: var(--text-secondary);">Немає отриманих запитів</p>
                </div>
              </div>

              <!-- Надіслані запити -->
              <div id="sent-requests-tab" class="tab-content">
                <div id="sent-requests" class="request-list">
                  <p style="color: var(--text-secondary);">Немає надісланих запитів</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Права колонка - Список друзів -->
          <div class="main-area">
            <div class="section">
              <h3 class="section-title">Ваші друзі</h3>
              <div id="friends-list" class="user-list">
                <p style="color: var(--text-secondary);">У вас поки немає друзів</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab content - Messages -->
      <div id="messages-tab" class="tab-content">
        <div class="section" style="padding: 0; overflow: hidden;">
          <div style="display: flex; height: 600px;">
            <!-- Список друзів для чату -->
            <div class="chat-sidebar">
              <div style="padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 style="font-size: 16px; font-weight: 500;">Ваші розмови</h3>
              </div>
              <ul id="chat-friends-list" class="friends-list">
                <li style="padding: 15px; text-align: center; color: var(--text-secondary);">
                  Виберіть друга для початку спілкування
                </li>
              </ul>
            </div>

            <!-- Область чату -->
            <div class="chat-content">
              <div id="no-chat-selected" style="display: flex; flex: 1; align-items: center; justify-content: center; color: var(--text-secondary);">
                <p>Оберіть співрозмовника зі списку друзів</p>
              </div>

              <div id="chat-area" style="display: none; flex: 1; flex-direction: column;">
                <div id="chat-header" class="chat-header">
                  <img id="chat-user-avatar" src="./images/default-avatar.svg" alt="User avatar" class="friend-avatar">
                  <div class="friend-info">
                    <div id="chat-user-name" class="friend-name">Ім'я користувача</div>
                  </div>
                </div>

                <div id="chat-messages" class="chat-messages">
                  <!-- Повідомлення будуть тут -->
                </div>

                <div class="chat-form">
                  <input type="text" id="message-input" class="chat-input" placeholder="Введіть повідомлення...">
                  <button id="send-message-btn" class="btn btn-primary">Надіслати</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Шаблони для швидкого створення елементів через JavaScript -->
  <template id="user-card-template">
    <div class="user-card">
      <img class="user-avatar" src="./images/default-avatar.svg" alt="User avatar">
      <div class="user-name">Ім'я користувача</div>
      <div class="user-username">@username</div>
      <div class="user-actions">
        <button class="btn btn-primary add-friend-btn">Додати в друзі</button>
      </div>
    </div>
  </template>

  <template id="friend-card-template">
    <div class="user-card">
      <img class="user-avatar" src="./images/default-avatar.svg" alt="User avatar">
      <div class="user-name">Ім'я користувача</div>
      <div class="user-username">@username</div>
      <div class="user-actions">
        <button class="btn btn-primary message-btn">Повідомлення</button>
        <button class="btn btn-danger remove-friend-btn">Видалити</button>
      </div>
    </div>
  </template>

  <template id="request-item-template">
    <div class="request-item">
      <img class="request-avatar" src="./images/default-avatar.svg" alt="User avatar">
      <div class="request-info">
        <div class="request-name">Ім'я користувача</div>
        <div class="request-username">@username</div>
      </div>
      <div class="request-actions">
        <button class="btn btn-sm btn-success accept-btn">Прийняти</button>
        <button class="btn btn-sm btn-danger decline-btn">Відхилити</button>
      </div>
    </div>
  </template>

  <template id="sent-request-item-template">
    <div class="request-item">
      <img class="request-avatar" src="./images/default-avatar.svg" alt="User avatar">
      <div class="request-info">
        <div class="request-name">Ім'я користувача</div>
        <div class="request-username">@username</div>
      </div>
      <div class="request-status" style="color: var(--text-secondary);">
        Очікує підтвердження
      </div>
    </div>
  </template>

  <template id="chat-friend-item-template">
    <li class="friend-item">
      <img class="friend-avatar" src="./images/default-avatar.svg" alt="Friend avatar">
      <div class="friend-info">
        <div class="friend-name">Ім'я друга</div>
        <div class="friend-status">Онлайн</div>
      </div>
      <div class="friend-unread" style="display: none;">0</div>
    </li>
  </template>

  <template id="message-template">
    <div class="message">
      <img class="message-avatar" src="./images/default-avatar.svg" alt="User avatar">
      <div class="message-content">
        <div class="message-text">Текст повідомлення</div>
        <div class="message-time">12:34</div>
      </div>
    </div>
  </template>

  <script>
    // Глобальні змінні
    let currentUser = null;
    let testUsers = [];
    let friends = [];
    let friendRequests = { sent: [], received: [] };
    let conversations = [];
    let currentChat = {
      userId: null,
      username: null,
      messages: []
    };

    // Створюємо базові тестові дані, якщо сервер не відповідає
    const fallbackTestUsers = [
      {
        _id: '123456789',
        username: 'testuser',
        email: 'test@example.com',
        fullName: 'Test User',
        avatar: './images/default-avatar.svg'
      },
      {
        _id: '987654321',
        username: 'testfriend',
        email: 'friend@example.com',
        fullName: 'Test Friend',
        avatar: './images/default-avatar.svg'
      },
      {
        _id: '111222333',
        username: 'alex_smith',
        email: 'alex@example.com',
        fullName: 'Alex Smith',
        avatar: './images/default-avatar.svg'
      }
    ];

    // Коли сторінка завантажена
    document.addEventListener('DOMContentLoaded', () => {
      // Перевірка авторизації
      const userJson = localStorage.getItem('user');
      const token = localStorage.getItem('token');

      if (userJson && token) {
        try {
          currentUser = JSON.parse(userJson);
          showMainContent();
          updateUserProfile();
          loadFriends();
          loadFriendRequests();
          loadConversations();
        } catch (error) {
          console.error('Error parsing user data:', error);
          showAuthScreen();
        }
      } else {
        showAuthScreen();
      }

      // Завантажити тестових користувачів для екрану авторизації
      loadTestUsers();

      // Налаштування обробників подій
      setupEventListeners();
    });

    // Функція для встановлення обробників подій
    function setupEventListeners() {
      // Кнопка виходу
      document.getElementById('logout-btn').addEventListener('click', logout);

      // Обробка вкладок верхнього рівня
      document.querySelectorAll('.tabs > .tab').forEach(tab => {
        tab.addEventListener('click', handleTabClick);
      });

      // Обробник для вкладок запитів на дружбу
      document.querySelectorAll('.section .tabs > .tab').forEach(tab => {
        tab.addEventListener('click', handleNestedTabClick);
      });

      // Поле пошуку користувачів
      const searchInput = document.getElementById('user-search');
      searchInput.addEventListener('input', debounce(handleUserSearch, 300));

      // Надсилання повідомлення
      document.getElementById('send-message-btn').addEventListener('click', sendMessage);
      document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }

    // Функція для показу екрану авторизації
    function showAuthScreen() {
      document.getElementById('auth-container').style.display = 'block';
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('logout-btn').style.display = 'none';

      // Показуємо тестових користувачів при першому завантаженні
      if (!testUsers || testUsers.length === 0) {
        testUsers = fallbackTestUsers;
        renderTestUsers();
      }
    }

    // Функція для показу основного контенту
    function showMainContent() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('logout-btn').style.display = 'inline-block';
    }

    // Функція для оновлення профілю користувача
    function updateUserProfile() {
      const avatar = document.getElementById('current-user-avatar');
      const name = document.getElementById('current-user-name');
      const username = document.getElementById('current-user-username');

      if (currentUser) {
        avatar.src = currentUser.avatar || './images/default-avatar.svg';
        name.textContent = currentUser.fullName || 'Користувач';
        username.textContent = '@' + currentUser.username;
      }
    }

    // Функція для отримання тестових користувачів
    async function loadTestUsers() {
      try {
        const response = await fetch('/social/test-users', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          testUsers = await response.json();
          renderTestUsers();
        } else {
          console.error('Failed to load test users:', await response.text());
          // Use fallback test users if server fails
          testUsers = fallbackTestUsers;
          renderTestUsers();
        }
      } catch (error) {
        console.error('Error loading test users:', error);
        // Use fallback test users if server fails
        testUsers = fallbackTestUsers;
        renderTestUsers();
      }
    }

    // Функція для входу як тестовий користувач
    function loginAsTestUser(userId) {
      // Find the user in our test users
      const user = testUsers.find(u => u._id === userId);

      if (!user) {
        alert('Користувача не знайдено');
        return;
      }

      // Create mock token and user data
      const mockToken = `token-${userId}-${Date.now() + 86400000}`;
      localStorage.setItem('token', mockToken);
      localStorage.setItem('user', JSON.stringify({
        id: user._id,
        username: user.username,
        email: user.email,
        fullName: user.fullName,
        avatar: user.avatar
      }));

      currentUser = {
        id: user._id,
        username: user.username,
        email: user.email,
        fullName: user.fullName,
        avatar: user.avatar
      };

      // Update UI
      showMainContent();
      updateUserProfile();

      // Initialize with empty friends list since we're mocking
      friends = [];
      renderFriends();

      // Initialize with empty requests
      friendRequests = { sent: [], received: [] };
      renderFriendRequests();

      // Initialize with empty conversations
      conversations = [];
      updateChatFriendsList();
    }

    // Функція для виходу з системи
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      currentUser = null;
      friends = [];
      friendRequests = { sent: [], received: [] };
      conversations = [];
      currentChat = { userId: null, username: null, messages: [] };

      showAuthScreen();
      loadTestUsers();
    }

    // Функція для відображення тестових користувачів
    function renderTestUsers() {
      const container = document.getElementById('test-users-list');

      if (!testUsers.length) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Тестових користувачів не знайдено</p>';
        return;
      }

      container.innerHTML = '';

      testUsers.forEach(user => {
        const template = document.getElementById('user-card-template');
        const userCard = template.content.cloneNode(true);

        const avatar = userCard.querySelector('.user-avatar');
        avatar.src = user.avatar || './images/default-avatar.svg';
        avatar.alt = user.username;

        userCard.querySelector('.user-name').textContent = user.fullName || user.username;
        userCard.querySelector('.user-username').textContent = '@' + user.username;

        const actionsDiv = userCard.querySelector('.user-actions');
        actionsDiv.innerHTML = '';

        const loginButton = document.createElement('button');
        loginButton.className = 'btn btn-primary';
        loginButton.textContent = 'Увійти як';
        loginButton.addEventListener('click', () => loginAsTestUser(user._id));

        actionsDiv.appendChild(loginButton);
        container.appendChild(userCard);
      });
    }

    // Функція для отримання друзів
    async function loadFriends() {
      if (!currentUser) return;

      try {
        const response = await fetch('/social/friends', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          friends = await response.json();
          renderFriends();
        } else {
          console.error('Failed to load friends:', await response.text());
        }
      } catch (error) {
        console.error('Error loading friends:', error);
      }
    }

    // Функція для отримання запитів на дружбу
    async function loadFriendRequests() {
      if (!currentUser) return;

      try {
        const response = await fetch('/social/friend-requests', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          friendRequests = await response.json();
          renderFriendRequests();
        } else {
          console.error('Failed to load friend requests:', await response.text());
        }
      } catch (error) {
        console.error('Error loading friend requests:', error);
      }
    }

    // Функція для надсилання запиту на дружбу
    async function sendFriendRequest(userId) {
      if (!currentUser) return;

      try {
        const response = await fetch(`/social/friend-request/${userId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          alert('Запит на дружбу надіслано!');
          loadFriendRequests();
          handleUserSearch(); // Оновити результати пошуку
        } else {
          const errorData = await response.json();
          alert(`Помилка: ${errorData.message}`);
        }
      } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Помилка при надсиланні запиту на дружбу');
      }
    }

    // Функція для прийняття запиту на дружбу
    async function acceptFriendRequest(userId) {
      if (!currentUser) return;

      try {
        const response = await fetch(`/social/accept-friend/${userId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          alert('Запит на дружбу прийнято!');
          loadFriends();
          loadFriendRequests();
        } else {
          const errorData = await response.json();
          alert(`Помилка: ${errorData.message}`);
        }
      } catch (error) {
        console.error('Error accepting friend request:', error);
        alert('Помилка при прийнятті запиту на дружбу');
      }
    }

    // Функція для відхилення запиту на дружбу
    async function declineFriendRequest(userId) {
      if (!currentUser) return;

      try {
        const response = await fetch(`/social/decline-friend/${userId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          alert('Запит на дружбу відхилено');
          loadFriendRequests();
        } else {
          const errorData = await response.json();
          alert(`Помилка: ${errorData.message}`);
        }
      } catch (error) {
        console.error('Error declining friend request:', error);
        alert('Помилка при відхиленні запиту на дружбу');
      }
    }

    // Функція для видалення друга
    async function removeFriend(userId) {
      if (!currentUser) return;

      if (!confirm('Ви впевнені, що хочете видалити цього друга?')) {
        return;
      }

      try {
        const response = await fetch(`/social/friend/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          alert('Друга видалено');
          loadFriends();

          // Оновити чат, якщо видалення стосується поточного співрозмовника
          if (currentChat.userId === userId) {
            currentChat = { userId: null, username: null, messages: [] };
            document.getElementById('no-chat-selected').style.display = 'flex';
            document.getElementById('chat-area').style.display = 'none';
          }

          // Оновити список розмов
          loadConversations();
        } else {
          const errorData = await response.json();
          alert(`Помилка: ${errorData.message}`);
        }
      } catch (error) {
        console.error('Error removing friend:', error);
        alert('Помилка при видаленні друга');
      }
    }

    // Функція для відображення друзів
    function renderFriends() {
      const container = document.getElementById('friends-list');

      if (!friends.length) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">У вас поки немає друзів</p>';
        return;
      }

      container.innerHTML = '';

      friends.forEach(friend => {
        const template = document.getElementById('friend-card-template');
        const friendCard = template.content.cloneNode(true);

        const avatar = friendCard.querySelector('.user-avatar');
        avatar.src = friend.avatar || './images/default-avatar.svg';
        avatar.alt = friend.username;

        friendCard.querySelector('.user-name').textContent = friend.fullName || friend.username;
        friendCard.querySelector('.user-username').textContent = '@' + friend.username;

        // Додати обробники подій для кнопок
        const messageBtn = friendCard.querySelector('.message-btn');
        messageBtn.addEventListener('click', () => {
          // Переключити на вкладку повідомлень і вибрати цього друга
          document.querySelector('.tabs > .tab[data-tab="messages"]').click();
          selectChatFriend(friend._id, friend.username, friend.avatar || './images/default-avatar.svg');
        });

        const removeBtn = friendCard.querySelector('.remove-friend-btn');
        removeBtn.addEventListener('click', () => removeFriend(friend._id));

        container.appendChild(friendCard);
      });

      // Оновити список друзів для чату
      updateChatFriendsList();
    }

    // Функція для відображення запитів на дружбу
    function renderFriendRequests() {
      const receivedContainer = document.getElementById('received-requests');
      const sentContainer = document.getElementById('sent-requests');

      // Отримані запити
      if (!friendRequests.received || !friendRequests.received.length) {
        receivedContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Немає отриманих запитів на дружбу</p>';
      } else {
        receivedContainer.innerHTML = '';

        friendRequests.received.forEach(request => {
          const template = document.getElementById('request-item-template');
          const requestItem = template.content.cloneNode(true);

          const avatar = requestItem.querySelector('.request-avatar');
          avatar.src = request.avatar || './images/default-avatar.svg';
          avatar.alt = request.username;

          requestItem.querySelector('.request-name').textContent = request.fullName || request.username;
          requestItem.querySelector('.request-username').textContent = '@' + request.username;

          // Додати обробники подій для кнопок
          const acceptBtn = requestItem.querySelector('.accept-btn');
          acceptBtn.addEventListener('click', () => acceptFriendRequest(request._id));

          const declineBtn = requestItem.querySelector('.decline-btn');
          declineBtn.addEventListener('click', () => declineFriendRequest(request._id));

          receivedContainer.appendChild(requestItem);
        });
      }

      // Надіслані запити
      if (!friendRequests.sent || !friendRequests.sent.length) {
        sentContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Немає надісланих запитів на дружбу</p>';
      } else {
        sentContainer.innerHTML = '';

        friendRequests.sent.forEach(request => {
          const template = document.getElementById('sent-request-item-template');
          const requestItem = template.content.cloneNode(true);

          const avatar = requestItem.querySelector('.request-avatar');
          avatar.src = request.avatar || './images/default-avatar.svg';
          avatar.alt = request.username;

          requestItem.querySelector('.request-name').textContent = request.fullName || request.username;
          requestItem.querySelector('.request-username').textContent = '@' + request.username;

          sentContainer.appendChild(requestItem);
        });
      }
    }

    // Функція для пошуку користувачів
    async function handleUserSearch() {
      if (!currentUser) return;

      const searchInput = document.getElementById('user-search');
      const query = searchInput.value.trim();
      const resultsContainer = document.getElementById('search-results');

      if (!query) {
        resultsContainer.innerHTML = '';
        return;
      }

      if (query.length < 2) {
        resultsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Введіть мінімум 2 символи для пошуку</p>';
        return;
      }

      try {
        const response = await fetch(`/social-extended/users/search?query=${encodeURIComponent(query)}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          const users = await response.json();

          if (!users.length) {
            resultsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Користувачів не знайдено</p>';
            return;
          }

          resultsContainer.innerHTML = '';

          users.forEach(user => {
            const template = document.getElementById('user-card-template');
            const userCard = template.content.cloneNode(true);

            const avatar = userCard.querySelector('.user-avatar');
            avatar.src = user.avatar || './images/default-avatar.svg';
            avatar.alt = user.username;

            userCard.querySelector('.user-name').textContent = user.fullName || user.username;
            userCard.querySelector('.user-username').textContent = '@' + user.username;

            const addFriendBtn = userCard.querySelector('.add-friend-btn');

            // Перевірка чи користувач вже є другом
            const isFriend = friends.some(friend => friend._id === user._id);

            // Перевірка чи запит вже надіслано
            const isRequestSent = friendRequests.sent && friendRequests.sent.some(request => request._id === user._id);

            // Перевірка чи отримано запит від цього користувача
            const isRequestReceived = friendRequests.received && friendRequests.received.some(request => request._id === user._id);

            if (isFriend) {
              addFriendBtn.textContent = 'Вже в друзях';
              addFriendBtn.disabled = true;
              addFriendBtn.classList.add('btn-success');
            } else if (isRequestSent) {
              addFriendBtn.textContent = 'Запит надіслано';
              addFriendBtn.disabled = true;
            } else if (isRequestReceived) {
              addFriendBtn.textContent = 'Прийняти запит';
              addFriendBtn.classList.add('btn-success');
              addFriendBtn.addEventListener('click', () => acceptFriendRequest(user._id));
            } else {
              addFriendBtn.addEventListener('click', () => sendFriendRequest(user._id));
            }

            resultsContainer.appendChild(userCard);
          });
        } else {
          resultsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Помилка при пошуку користувачів</p>';
          console.error('Error searching users:', await response.text());
        }
      } catch (error) {
        resultsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Помилка з\'єднання з сервером</p>';
        console.error('Error searching users:', error);
      }
    }

    // Обробка кліків по вкладках верхнього рівня
    function handleTabClick(event) {
      const tabId = event.target.getAttribute('data-tab');

      // Деактивувати всі вкладки
      document.querySelectorAll('.tabs > .tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Активувати натиснуту вкладку
      event.target.classList.add('active');

      // Сховати всі контенти вкладок
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Показати потрібний контент
      document.getElementById(`${tabId}-tab`).classList.add('active');

      // Оновити дані, якщо потрібно
      if (tabId === 'messages') {
        loadConversations();
      }
    }

    // Обробка кліків по вкладках другого рівня (запити дружби)
    function handleNestedTabClick(event) {
      const tabSection = event.target.closest('.tabs');
      const tabId = event.target.getAttribute('data-tab');

      // Деактивувати всі вкладки в цій секції
      tabSection.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Активувати натиснуту вкладку
      event.target.classList.add('active');

      // Знайти батьківський елемент секції
      const parentSection = tabSection.closest('.section');

      // Сховати всі контенти вкладок в цій секції
      parentSection.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Показати потрібний контент
      parentSection.querySelector(`#${tabId}-tab`).classList.add('active');
    }

    // Функція Debounce для пошуку
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Функція для отримання списку розмов
    async function loadConversations() {
      if (!currentUser) return;

      try {
        const response = await fetch('/messages/conversations', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          conversations = await response.json();
          updateChatFriendsList();
        } else {
          console.error('Failed to load conversations:', await response.text());
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
      }
    }

    // Функція для оновлення списку друзів в чаті
    function updateChatFriendsList() {
      const chatFriendsList = document.getElementById('chat-friends-list');

      if (!friends.length && !conversations.length) {
        chatFriendsList.innerHTML = '<li style="padding: 15px; text-align: center; color: var(--text-secondary);">У вас немає розмов</li>';
        return;
      }

      chatFriendsList.innerHTML = '';

      // Об'єднаємо друзів із розмовами, щоб показати останні повідомлення
      const chatItems = [];

      // Додаємо всіх друзів
      friends.forEach(friend => {
        const conversation = conversations.find(conv =>
          conv.participants.some(p => p._id === friend._id)
        );

        chatItems.push({
          _id: friend._id,
          username: friend.username,
          fullName: friend.fullName || friend.username,
          avatar: friend.avatar || './images/default-avatar.svg',
          lastMessage: conversation?.lastMessage?.content || null,
          updatedAt: conversation?.updatedAt || null,
          unreadCount: conversation?.unreadCount || 0
        });
      });

      // Сортуємо за датою останнього повідомлення (найновіші спочатку)
      chatItems.sort((a, b) => {
        if (!a.updatedAt) return 1;
        if (!b.updatedAt) return -1;
        return new Date(b.updatedAt) - new Date(a.updatedAt);
      });

      // Відображаємо список
      chatItems.forEach(item => {
        const template = document.getElementById('chat-friend-item-template');
        const friendItem = template.content.cloneNode(true);

        const avatar = friendItem.querySelector('.friend-avatar');
        avatar.src = item.avatar;
        avatar.alt = item.username;

        friendItem.querySelector('.friend-name').textContent = item.fullName;

        const statusElement = friendItem.querySelector('.friend-status');
        if (item.lastMessage) {
          const date = new Date(item.updatedAt);
          const formattedDate = date.toLocaleString('uk-UA', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          statusElement.textContent = `${item.lastMessage.slice(0, 20)}${item.lastMessage.length > 20 ? '...' : ''} • ${formattedDate}`;
        } else {
          statusElement.textContent = 'Немає повідомлень';
        }

        const unreadElement = friendItem.querySelector('.friend-unread');
        if (item.unreadCount && item.unreadCount > 0) {
          unreadElement.textContent = item.unreadCount;
          unreadElement.style.display = 'flex';
        }

        const listItem = friendItem.querySelector('.friend-item');
        listItem.addEventListener('click', () => {
          selectChatFriend(item._id, item.username, item.avatar);
        });

        // Якщо це поточний чат, виділяємо його
        if (currentChat.userId === item._id) {
          listItem.classList.add('active');
        }

        chatFriendsList.appendChild(friendItem);
      });
    }

    // Функція для вибору друга в чаті
    function selectChatFriend(userId, username, avatar) {
      currentChat.userId = userId;
      currentChat.username = username;
      currentChat.messages = [];

      // Оновити заголовок чату
      document.getElementById('chat-user-avatar').src = avatar;
      document.getElementById('chat-user-name').textContent = username;

      // Показати область чату
      document.getElementById('no-chat-selected').style.display = 'none';
      document.getElementById('chat-area').style.display = 'flex';

      // Завантажити повідомлення
      loadMessages(userId);

      // Виділити поточний чат в списку
      const chatList = document.getElementById('chat-friends-list');
      chatList.querySelectorAll('.friend-item').forEach(item => {
        item.classList.remove('active');
      });

      // Знайти елемент і виділити його
      const chatItems = chatList.querySelectorAll('.friend-item');
      for (const item of chatItems) {
        if (item.querySelector('.friend-name').textContent === (username || userId)) {
          item.classList.add('active');
          break;
        }
      }
    }

    // Функція для отримання повідомлень
    async function loadMessages(userId) {
      if (!currentUser || !userId) return;

      // Спочатку знайдемо розмову з цим користувачем
      let conversationId = null;
      for (const conv of conversations) {
        if (conv.participants.some(p => p._id === userId)) {
          conversationId = conv.id;
          break;
        }
      }

      // Якщо розмови немає, очистимо чат і вийдемо
      if (!conversationId) {
        document.getElementById('chat-messages').innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 20px;">Немає повідомлень</p>';
        return;
      }

      try {
        const response = await fetch(`/messages/conversations/${conversationId}/messages`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          const messages = await response.json();
          currentChat.messages = messages;
          renderMessages();

          // Оновити список розмов (щоб оновити лічильник непрочитаних)
          setTimeout(loadConversations, 500);
        } else {
          console.error('Failed to load messages:', await response.text());
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Функція для відображення повідомлень
    function renderMessages() {
      const messagesContainer = document.getElementById('chat-messages');

      if (!currentChat.messages.length) {
        messagesContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 20px;">Немає повідомлень</p>';
        return;
      }

      messagesContainer.innerHTML = '';

      // Відсортувати повідомлення за датою (найстаріші спочатку)
      const sortedMessages = [...currentChat.messages].sort((a, b) =>
        new Date(a.createdAt) - new Date(b.createdAt)
      );

      sortedMessages.forEach(message => {
        const template = document.getElementById('message-template');
        const messageItem = template.content.cloneNode(true);

        const messageElement = messageItem.querySelector('.message');
        const isOutgoing = message.sender._id === currentUser.id;

        if (isOutgoing) {
          messageElement.classList.add('outgoing');
        } else {
          messageElement.classList.add('incoming');
        }

        const avatar = messageItem.querySelector('.message-avatar');
        avatar.src = isOutgoing ?
          (currentUser.avatar || './images/default-avatar.svg') :
          (message.sender.avatar || './images/default-avatar.svg');

        messageItem.querySelector('.message-text').textContent = message.content;

        const date = new Date(message.createdAt);
        const timeString = date.toLocaleTimeString('uk-UA', {hour: '2-digit', minute: '2-digit'});
        messageItem.querySelector('.message-time').textContent = timeString;

        messagesContainer.appendChild(messageItem);
      });

      // Прокрутити до останнього повідомлення
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Функція для надсилання повідомлення
    async function sendMessage() {
      if (!currentUser || !currentChat.userId) return;

      const messageInput = document.getElementById('message-input');
      const content = messageInput.value.trim();

      if (!content) return;

      try {
        const response = await fetch('/messages/send', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientId: currentChat.userId,
            content
          })
        });

        if (response.ok) {
          const result = await response.json();

          // Додати нове повідомлення до чату
          currentChat.messages.push(result.data);
          renderMessages();

          // Очистити поле вводу
          messageInput.value = '';

          // Оновити список розмов
          setTimeout(loadConversations, 500);
        } else {
          console.error('Failed to send message:', await response.text());
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }
  </script>
</body>
</html>
